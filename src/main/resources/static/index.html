<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solace Server Simulator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
        }

        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .panel h2 {
            color: #34495e;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }

        input[type="text"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-top: 10px;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: #27ae60;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #fafafa;
        }

        .message-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .message-item .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .message-item .message-destination {
            font-weight: 600;
            color: #2c3e50;
        }

        .message-item .message-type {
            background-color: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
        }

        .message-item .message-content {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            margin-bottom: 10px;
        }

        .message-item .message-hex {
            background-color: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            margin-bottom: 10px;
        }

        .message-item .message-headers {
            font-size: 12px;
            color: #666;
        }

        .message-item .message-timestamp {
            font-size: 12px;
            color: #999;
            text-align: right;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .header-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .header-input input {
            flex: 1;
        }

        .header-list {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .header-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background: white;
            margin-bottom: 5px;
            border-radius: 3px;
        }

        .header-item button {
            padding: 3px 8px;
            margin: 0;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Solace Server Simulator</h1>

        <!-- Connection Panel -->
        <div class="panel">
            <h2>Connection Configuration</h2>
            <div id="connectionStatus" class="status disconnected">
                Status: Disconnected
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label for="host">Host:</label>
                    <input type="text" id="host" placeholder="tcp://localhost:55555" value="tcp://localhost:55555">
                </div>
                <div class="form-group">
                    <label for="vpnName">VPN Name:</label>
                    <input type="text" id="vpnName" placeholder="default" value="default">
                </div>
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" placeholder="admin" value="admin">
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" placeholder="admin" value="admin">
                </div>
            </div>
            <button id="connectBtn" onclick="connect()">Connect</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled class="btn-danger">Disconnect</button>
        </div>

        <!-- Send Message Panel -->
        <div class="panel">
            <h2>Send Message</h2>
            <div class="grid-2">
                <div class="form-group">
                    <label for="sendDestination">Destination:</label>
                    <input type="text" id="sendDestination" placeholder="my/topic or queue.name">
                </div>
                <div class="form-group">
                    <label for="sendDestinationType">Destination Type:</label>
                    <select id="sendDestinationType">
                        <option value="TOPIC">Topic</option>
                        <option value="QUEUE">Queue</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sendMessageType">Message Type:</label>
                    <select id="sendMessageType" onchange="toggleMessageTypeHelp()">
                        <option value="TEXT">Text</option>
                        <option value="BYTE">Byte (Hexadecimal)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sendReplyTo">JMSReplyTo (optional):</label>
                    <input type="text" id="sendReplyTo" placeholder="reply/topic or #Q/reply.queue">
                </div>
            </div>
            <div class="form-group">
                <label for="sendContent">Message Content:</label>
                <textarea id="sendContent" placeholder="Enter text message or hex bytes (e.g., 48656C6C6F)"></textarea>
                <small id="messageTypeHelp" style="color: #666; display: none;">
                    For byte messages, enter hexadecimal values (e.g., 48 65 6C 6C 6F for "Hello")
                </small>
            </div>
            <div class="form-group">
                <label>Custom Headers:</label>
                <div class="header-input">
                    <input type="text" id="headerKey" placeholder="Header Key">
                    <input type="text" id="headerValue" placeholder="Header Value">
                    <button onclick="addHeader()">Add Header</button>
                </div>
                <div id="headerList" class="header-list" style="display: none;"></div>
            </div>
            <button onclick="sendMessage()" class="btn-success">Send Message</button>
        </div>

        <!-- Subscribe Panel -->
        <div class="panel">
            <h2>Subscribe to Topic/Queue</h2>
            <div class="grid-2">
                <div class="form-group">
                    <label for="subDestination">Destination:</label>
                    <input type="text" id="subDestination" placeholder="my/topic or queue.name">
                </div>
                <div class="form-group">
                    <label for="subDestinationType">Destination Type:</label>
                    <select id="subDestinationType">
                        <option value="TOPIC">Topic</option>
                        <option value="QUEUE">Queue</option>
                    </select>
                </div>
            </div>
            <button onclick="subscribe()" class="btn-success">Subscribe</button>
            <button onclick="unsubscribe()" class="btn-danger">Unsubscribe</button>
        </div>

        <!-- ACP Message Mapper Panel -->
        <div class="panel">
            <h2>ACP Message Mapper</h2>
            <p style="color: #666; margin-bottom: 15px;">
                Parse hexadecimal byte messages into structured fields using little-endian byte order.
            </p>
            <div class="form-group">
                <label for="acpHexInput">Hexadecimal Input:</label>
                <textarea id="acpHexInput" placeholder="Enter hexadecimal string (e.g., F30A291408000101...)"></textarea>
                <small style="color: #666;">
                    Enter hex values with or without spaces. Example: F30A (0xF3 0x0A) = 2803 in little-endian
                </small>
            </div>
            <button onclick="parseAcpMessage()" class="btn-success">Parse Message</button>
            <button onclick="clearAcpResult()" class="btn-danger">Clear</button>
            
            <div id="acpResult" style="display: none; margin-top: 20px;">
                <h3 style="color: #34495e; margin-bottom: 10px;">Parsed Result:</h3>
                
                <div class="form-group">
                    <label>Raw Hexadecimal:</label>
                    <div id="acpRawHex" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; font-family: 'Courier New', monospace; word-break: break-all;"></div>
                </div>
                
                <div class="form-group">
                    <label>Binary Representation:</label>
                    <div id="acpBinary" style="background-color: #fff3cd; padding: 10px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 11px; word-break: break-all; max-height: 150px; overflow-y: auto;"></div>
                </div>
                
                <div class="form-group">
                    <label>Parsed Fields (Little-Endian):</label>
                    <div id="acpFields" style="background-color: #d4edda; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- Received Messages Panel -->
        <div class="panel">
            <h2>Received Messages</h2>
            <button onclick="clearMessages()" class="btn-danger">Clear Messages</button>
            <div id="messageList" class="message-list">
                <p style="color: #999; text-align: center; padding: 20px;">No messages received yet...</p>
            </div>
        </div>
    </div>

    <script src="/js/sockjs.min.js"></script>
    <script src="/js/stomp.min.js"></script>
    <script>
        let stompClient = null;
        let isConnectedToSolace = false;
        let headers = {};

        // Initialize WebSocket connection
        function initWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                console.log('Connected to WebSocket: ' + frame);
                stompClient.subscribe('/topic/messages', function(message) {
                    displayMessage(JSON.parse(message.body));
                });
            });
        }

        function toggleMessageTypeHelp() {
            const messageType = document.getElementById('sendMessageType').value;
            const help = document.getElementById('messageTypeHelp');
            help.style.display = messageType === 'BYTE' ? 'block' : 'none';
        }

        function addHeader() {
            const key = document.getElementById('headerKey').value.trim();
            const value = document.getElementById('headerValue').value.trim();
            
            if (key && value) {
                headers[key] = value;
                document.getElementById('headerKey').value = '';
                document.getElementById('headerValue').value = '';
                updateHeaderList();
            }
        }

        function removeHeader(key) {
            delete headers[key];
            updateHeaderList();
        }

        function updateHeaderList() {
            const headerList = document.getElementById('headerList');
            if (Object.keys(headers).length === 0) {
                headerList.style.display = 'none';
                return;
            }

            headerList.style.display = 'block';
            headerList.innerHTML = '';
            for (const [key, value] of Object.entries(headers)) {
                const item = document.createElement('div');
                item.className = 'header-item';
                item.innerHTML = `
                    <span><strong>${key}:</strong> ${value}</span>
                    <button onclick="removeHeader('${key}')" class="btn-danger">Remove</button>
                `;
                headerList.appendChild(item);
            }
        }

        function connect() {
            const config = {
                host: document.getElementById('host').value,
                vpnName: document.getElementById('vpnName').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                port: ''
            };

            fetch('/api/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    isConnectedToSolace = true;
                    updateConnectionStatus(true);
                    alert('Connected successfully!');
                } else {
                    alert('Connection failed: ' + data.message);
                }
            })
            .catch(error => {
                alert('Connection error: ' + error);
            });
        }

        function disconnect() {
            fetch('/api/disconnect', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                isConnectedToSolace = false;
                updateConnectionStatus(false);
                alert('Disconnected successfully!');
            })
            .catch(error => {
                alert('Disconnect error: ' + error);
            });
        }

        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = 'Status: Connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = 'Status: Disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function sendMessage() {
            if (!isConnectedToSolace) {
                alert('Please connect to Solace broker first!');
                return;
            }

            const request = {
                destination: document.getElementById('sendDestination').value,
                destinationType: document.getElementById('sendDestinationType').value,
                messageType: document.getElementById('sendMessageType').value,
                content: document.getElementById('sendContent').value,
                replyTo: document.getElementById('sendReplyTo').value,
                headers: headers
            };

            fetch('/api/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(request)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Message sent successfully!');
                    document.getElementById('sendContent').value = '';
                } else {
                    alert('Send failed: ' + data.message);
                }
            })
            .catch(error => {
                alert('Send error: ' + error);
            });
        }

        function subscribe() {
            if (!isConnectedToSolace) {
                alert('Please connect to Solace broker first!');
                return;
            }

            const request = {
                destination: document.getElementById('subDestination').value,
                destinationType: document.getElementById('subDestinationType').value
            };

            fetch('/api/subscribe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(request)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                } else {
                    alert('Subscribe failed: ' + data.message);
                }
            })
            .catch(error => {
                alert('Subscribe error: ' + error);
            });
        }

        function unsubscribe() {
            if (!isConnectedToSolace) {
                alert('Please connect to Solace broker first!');
                return;
            }

            const request = {
                destination: document.getElementById('subDestination').value,
                destinationType: document.getElementById('subDestinationType').value
            };

            fetch('/api/unsubscribe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(request)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                } else {
                    alert('Unsubscribe failed: ' + data.message);
                }
            })
            .catch(error => {
                alert('Unsubscribe error: ' + error);
            });
        }

        function displayMessage(message) {
            const messageList = document.getElementById('messageList');
            
            // Remove "no messages" placeholder
            if (messageList.children.length === 1 && messageList.children[0].tagName === 'P') {
                messageList.innerHTML = '';
            }

            const messageItem = document.createElement('div');
            messageItem.className = 'message-item';
            
            let headersHtml = '';
            if (message.headers && Object.keys(message.headers).length > 0) {
                headersHtml = '<div class="message-headers"><strong>Headers:</strong><br>';
                for (const [key, value] of Object.entries(message.headers)) {
                    headersHtml += `${key}: ${value}<br>`;
                }
                headersHtml += '</div>';
            }

            messageItem.innerHTML = `
                <div class="message-header">
                    <div class="message-destination">${message.destination}</div>
                    <div class="message-type">${message.messageType}</div>
                </div>
                <div class="message-content"><strong>Content:</strong><br>${escapeHtml(message.content || '')}</div>
                <div class="message-hex"><strong>Hex:</strong><br>${message.hexContent || ''}</div>
                ${headersHtml}
                <div class="message-timestamp">${new Date(message.timestamp).toLocaleString()}</div>
            `;

            messageList.insertBefore(messageItem, messageList.firstChild);
        }

        function clearMessages() {
            const messageList = document.getElementById('messageList');
            messageList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No messages received yet...</p>';
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // ACP Message Parser Functions
        function parseAcpMessage() {
            const hexInput = document.getElementById('acpHexInput').value.trim();
            
            if (!hexInput) {
                alert('Please enter a hexadecimal string');
                return;
            }
            
            fetch('/api/acp/parse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ hexString: hexInput })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'error') {
                    alert('Parse error: ' + data.message);
                } else {
                    displayAcpResult(data);
                }
            })
            .catch(error => {
                alert('Parse error: ' + error);
            });
        }

        function displayAcpResult(acpMessage) {
            // Display raw hex
            document.getElementById('acpRawHex').textContent = acpMessage.rawHex;
            
            // Display binary string
            const binary = acpMessage.binaryString;
            const formattedBinary = binary.match(/.{1,8}/g).join(' ');
            document.getElementById('acpBinary').textContent = formattedBinary;
            
            // Display parsed fields
            const fieldsDiv = document.getElementById('acpFields');
            fieldsDiv.innerHTML = '';
            
            const fieldsTable = document.createElement('table');
            fieldsTable.style.width = '100%';
            fieldsTable.style.borderCollapse = 'collapse';
            
            // Add header
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr style="background-color: #3498db; color: white;">
                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Field Name</th>
                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Value</th>
                </tr>
            `;
            fieldsTable.appendChild(thead);
            
            // Add fields
            const tbody = document.createElement('tbody');
            for (const [key, value] of Object.entries(acpMessage.fields)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">${escapeHtml(key)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; font-family: 'Courier New', monospace;">${escapeHtml(String(value))}</td>
                `;
                tbody.appendChild(row);
            }
            fieldsTable.appendChild(tbody);
            
            fieldsDiv.appendChild(fieldsTable);
            
            // Show result section
            document.getElementById('acpResult').style.display = 'block';
        }

        function clearAcpResult() {
            document.getElementById('acpHexInput').value = '';
            document.getElementById('acpResult').style.display = 'none';
        }

        // Check connection status on load
        function checkStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    isConnectedToSolace = data.connected;
                    updateConnectionStatus(data.connected);
                })
                .catch(error => {
                    console.error('Status check error:', error);
                });
        }

        // Initialize on page load
        window.onload = function() {
            initWebSocket();
            checkStatus();
        };
    </script>
</body>
</html>
